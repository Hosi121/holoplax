name: Staging Environment Control

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: ap-northeast-3
  CLUSTER_NAME: holoplax-staging-cluster
  SERVICE_NAME: holoplax-staging-app

jobs:
  control:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::245760921629:role/holoplax-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current status
        id: status
        run: |
          STATUS=$(aws ecs describe-services \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.SERVICE_NAME }} \
            --query 'services[0].{running:runningCount,desired:desiredCount}' \
            --output json)
          echo "current=$STATUS" >> $GITHUB_OUTPUT
          echo "### Current Status" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$STATUS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Start staging
        if: inputs.action == 'start'
        run: |
          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.SERVICE_NAME }} \
            --desired-count 1
          echo "### ✅ Staging Started" >> $GITHUB_STEP_SUMMARY
          echo "URL: http://holoplax-staging-alb-1675199248.ap-northeast-3.elb.amazonaws.com/" >> $GITHUB_STEP_SUMMARY

      - name: Stop staging
        if: inputs.action == 'stop'
        run: |
          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.SERVICE_NAME }} \
            --desired-count 0
          echo "### ⏹️ Staging Stopped" >> $GITHUB_STEP_SUMMARY

      - name: Show status only
        if: inputs.action == 'status'
        run: |
          echo "Status check completed. See summary above."
