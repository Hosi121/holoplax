name: CD

on:
  push:
    branches:
      - main
      - staging

env:
  AWS_REGION: ap-northeast-3

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      ecr_registry: ${{ steps.login-ecr.outputs.registry }}
      image_tag: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "name_prefix=holoplax-prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "name_prefix=holoplax-staging" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::245760921629:role/holoplax-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push app image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.set-env.outputs.name_prefix }}-app
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Build and push metrics image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.set-env.outputs.name_prefix }}-metrics
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ./scripts/metrics
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Build and push MCP server image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.set-env.outputs.name_prefix }}-mcp
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f mcp-server/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy-staging:
    needs: build-and-push
    if: github.ref_name == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::245760921629:role/holoplax-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Run Prisma migrations via ECS
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition and modify for migration
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-staging-app \
            --query 'taskDefinition' \
            --output json)

          # Create migration task definition with updated image and command
          MIGRATE_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-staging-app:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "app")).image = $IMAGE |
             (.containerDefinitions[] | select(.name == "app")).command = ["prisma", "migrate", "deploy"] |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
             .family = "holoplax-staging-migrate"')

          # Register migration task definition
          MIGRATE_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$MIGRATE_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Run migration task
          TASK_ARN=$(aws ecs run-task \
            --cluster holoplax-staging-cluster \
            --task-definition $MIGRATE_TASK_ARN \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$(aws ecs describe-services --cluster holoplax-staging-cluster --services holoplax-staging-app --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' --output text | tr '\t' ',')],securityGroups=[$(aws ecs describe-services --cluster holoplax-staging-cluster --services holoplax-staging-app --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups' --output text | tr '\t' ',')],assignPublicIp=ENABLED}" \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Migration task started: $TASK_ARN"

          # Wait for migration task to complete
          aws ecs wait tasks-stopped --cluster holoplax-staging-cluster --tasks $TASK_ARN

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks --cluster holoplax-staging-cluster --tasks $TASK_ARN \
            --query 'tasks[0].containers[?name==`app`].exitCode' --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "Migration failed with exit code: $EXIT_CODE"
            aws logs tail /ecs/holoplax-staging/app --since 5m || true
            exit 1
          fi

          echo "Migration completed successfully"

      - name: Update ECS service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-staging-app \
            --query 'taskDefinition' \
            --output json)

          # Update image and remove container health check (ALB health check is sufficient)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-staging-app:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "app")).image = $IMAGE | del(.containerDefinitions[].healthCheck) | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Update service with new task definition
          aws ecs update-service \
            --cluster holoplax-staging-cluster \
            --service holoplax-staging-app \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment

      - name: Wait for app deployment
        run: |
          aws ecs wait services-stable \
            --cluster holoplax-staging-cluster \
            --services holoplax-staging-app

      - name: Update MCP ECS service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Check if MCP service exists
          if ! aws ecs describe-services --cluster holoplax-staging-cluster --services holoplax-staging-mcp --query 'services[0].status' --output text 2>/dev/null | grep -q ACTIVE; then
            echo "MCP service not found, skipping deployment"
            exit 0
          fi

          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-staging-mcp \
            --query 'taskDefinition' \
            --output json)

          # Update image and remove container health check (ALB health check is sufficient)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-staging-mcp:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "mcp")).image = $IMAGE | del(.containerDefinitions[].healthCheck) | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Update service with new task definition
          aws ecs update-service \
            --cluster holoplax-staging-cluster \
            --service holoplax-staging-mcp \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment

      - name: Wait for MCP deployment
        run: |
          if aws ecs describe-services --cluster holoplax-staging-cluster --services holoplax-staging-mcp --query 'services[0].status' --output text 2>/dev/null | grep -q ACTIVE; then
            aws ecs wait services-stable \
              --cluster holoplax-staging-cluster \
              --services holoplax-staging-mcp
          fi

  deploy-prod:
    needs: build-and-push
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::245760921629:role/holoplax-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Run Prisma migrations via ECS
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition and modify for migration
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-prod-app \
            --query 'taskDefinition' \
            --output json)

          # Create migration task definition with updated image and command
          MIGRATE_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-prod-app:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "app")).image = $IMAGE |
             (.containerDefinitions[] | select(.name == "app")).command = ["prisma", "migrate", "deploy"] |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
             .family = "holoplax-prod-migrate"')

          # Register migration task definition
          MIGRATE_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$MIGRATE_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Run migration task
          TASK_ARN=$(aws ecs run-task \
            --cluster holoplax-prod-cluster \
            --task-definition $MIGRATE_TASK_ARN \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$(aws ecs describe-services --cluster holoplax-prod-cluster --services holoplax-prod-app --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' --output text | tr '\t' ',')],securityGroups=[$(aws ecs describe-services --cluster holoplax-prod-cluster --services holoplax-prod-app --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups' --output text | tr '\t' ',')],assignPublicIp=ENABLED}" \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Migration task started: $TASK_ARN"

          # Wait for migration task to complete
          aws ecs wait tasks-stopped --cluster holoplax-prod-cluster --tasks $TASK_ARN

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks --cluster holoplax-prod-cluster --tasks $TASK_ARN \
            --query 'tasks[0].containers[?name==`app`].exitCode' --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "Migration failed with exit code: $EXIT_CODE"
            aws logs tail /ecs/holoplax-prod/app --since 5m || true
            exit 1
          fi

          echo "Migration completed successfully"

      - name: Update ECS service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-prod-app \
            --query 'taskDefinition' \
            --output json)

          # Update image and remove container health check (ALB health check is sufficient)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-prod-app:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "app")).image = $IMAGE | del(.containerDefinitions[].healthCheck) | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Update service with new task definition
          aws ecs update-service \
            --cluster holoplax-prod-cluster \
            --service holoplax-prod-app \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment

      - name: Wait for app deployment
        run: |
          aws ecs wait services-stable \
            --cluster holoplax-prod-cluster \
            --services holoplax-prod-app

      - name: Update MCP ECS service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Check if MCP service exists
          if ! aws ecs describe-services --cluster holoplax-prod-cluster --services holoplax-prod-mcp --query 'services[0].status' --output text 2>/dev/null | grep -q ACTIVE; then
            echo "MCP service not found, skipping deployment"
            exit 0
          fi

          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition holoplax-prod-mcp \
            --query 'taskDefinition' \
            --output json)

          # Update image and remove container health check (ALB health check is sufficient)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$ECR_REGISTRY/holoplax-prod-mcp:$IMAGE_TAG" \
            '(.containerDefinitions[] | select(.name == "mcp")).image = $IMAGE | del(.containerDefinitions[].healthCheck) | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          # Update service with new task definition
          aws ecs update-service \
            --cluster holoplax-prod-cluster \
            --service holoplax-prod-mcp \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment

      - name: Wait for MCP deployment
        run: |
          if aws ecs describe-services --cluster holoplax-prod-cluster --services holoplax-prod-mcp --query 'services[0].status' --output text 2>/dev/null | grep -q ACTIVE; then
            aws ecs wait services-stable \
              --cluster holoplax-prod-cluster \
              --services holoplax-prod-mcp
          fi
